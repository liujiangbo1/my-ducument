<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="324"/>

<div>
<span><div>所有是ubuntu系统的minions都执行test.ping:</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>root@ubuntu:~# salt -G 'os:ubuntu' test.ping</div><div>ubuntu1:</div><div>    True</div><div><br/></div></div><div>返回操作系统多有信息：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>root@ubuntu:~# salt  ubuntu1  grains.items</div><div>ubuntu1:</div><div>  biosreleasedate: 07/02/2015</div><div>  biosversion: 6.00</div><div>  cpu_flags: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts nopl xtopology tsc_reliable nonstop_tsc aperfmperf eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch epb fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 invpcid rtm rdseed adx smap xsaveopt dtherm ida arat pln pts hwp hwp_notify hwp_act_window hwp_epp</div><div>  cpu_model: Intel(R) Core(TM) i5-6500 CPU @ 3.20GHz</div><div>  cpuarch: x86_64</div><div>  defaultencoding: None</div><div>  defaultlanguage: None</div><div>  domain:</div><div>  fqdn: ubuntu1</div><div>  fqdn_ip4:</div><div>  fqdn_ip6:</div><div>  gpus:</div><div>      {'model': 'SVGA II Adapter', 'vendor': 'unknown'}</div><div>  host: ubuntu1</div><div>  id: ubuntu1</div><div>  ip_interfaces: {'eth0': ['192.168.190.131'], 'docker0': ['172.17.0.1'], 'veth9fc8172': [], 'veth7bc5fce': [], 'lo': ['127.0.0.1'], 'veth15599ce': [], 'veth9d444c5': [], 'veth0717d88': [], 'vethee37c05': [], 'veth4ce75ba': [], 'docker_gwbridge': ['172.18.0.1'], 'veth695e94c': [], 'veth8cac166': [], 'veth1a0b0d5': [], 'vethdee3498': [], 'vethda3ae8e': []}</div><div>  ipv4:</div><div>      127.0.0.1</div><div>      172.17.0.1</div><div>      172.18.0.1</div><div>      192.168.190.131</div><div>  ipv6:</div><div>      ::1</div><div>      fe80::182e:37ff:fe4e:faea</div><div>      fe80::20c:29ff:fe29:ce4</div><div>....</div></div><div><br/></div><div>命令合成：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>root@ubuntu:~# salt -C  'G@os:ubuntu  and webser* or E@db.*'  test.ping</div></div><div>预定nodegroups允许在主配置文件中声明预定义的符合目标，这是一种符合表达式的简写形式：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>nodegroups:<br/>
group1: 'L@foo.domain.com,bar.domain.com,baz.domain.com and bl*.domain.com'<br/>
group2: 'G@os:Debian and foo.domain.com'</div><div>group3: 'G@os:Debian and N@group1'</div></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">vim  /etc/salt/master,nodegroups行加入groupN,然后重启，执行命令为：</span></span></span></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>salt    -N    groupN  test.ping</div></div><div><span style="font-size: 21px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 21px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);">匹配所有minions:</span></span></span></div><div><span style="font-size: 12px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>root@ubuntu:~# salt '*' test.ping</div><div>ubuntu1:</div><div>    True</div></div><div><span style="font-size: 21px;"><span style="font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;"><span style="color: rgb(51, 51, 51);"><br/></span></span></span></div><div><span style="font-size: 21px;">minions id匹配：</span></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>salt '*.example.net' test.ping<br/>
salt '*.example.*' test.ping</div><div><br/></div></div><div>匹配webN，例如（ (<code>web1.example.net</code>, <code>web2.example.net</code> … <code>webN.example.net</code>)）：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>salt 'web?.example.net' test.ping<br/><br/></div></div><div><br/></div><div>匹配web1到web5:</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>salt 'web[1-5]' test.ping<br/><br/></div></div><div><br/></div><div>匹配web1和web3:</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>salt 'web[1,3]' test.ping<br/><br/></div></div><div><br/></div><div><br/></div><div><span style="font-size: 24px;">正则匹配：</span></div><div>匹配web1-prod和web-devel:</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>salt -E 'web1-(prod|devel)' test.ping<br/><br/></div></div><div><br/></div><div>使用正则匹配state's top  file，首先要指定要匹配的machers,如下：</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>base:<br/>
  'web1-(prod|devel)':<br/>
  - match: pcre<br/>
  - webserver</div></div><div><br/></div><div><br/></div><div><span style="font-size: 21px;">list：</span></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>salt -L 'web1,web2,web3' test.ping<br/><br/></div></div><div><br/></div><div><br/></div><div><span style="font-size: 19px;">cp.get_file:</span>拷贝文件（安装包、目录）</div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>[root@liujiangbu salt]# salt  visual2 cp.get_file  salt://apache/httpd.conf.tar.gz  /usr/local/httpd.conf.tar.gz   #这里要注意，要拷贝到目标机器的指定目录下，要指定包名字，最好一样，不然只写个目录路径会报错的！</div><div>visual2:</div><div>    /usr/local/httpd.conf.tar.gz</div></div><div><br/></div><div>批处理大小（<span style="font-size: 26px;"><b>Batch Size</b></span>）： </div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>salt '*' -b 10 test.ping     #10个minions上运行test.ping命令</div><div> </div><div>salt -G 'os:RedHat' --batch-size 25% apache.signal restart   #25%的机器上执行apache重启</div><div><br/></div></div><div><br/></div><div><br/></div><div><br/></div><div>开启minion可以向master  push文件，vim  /etc/salt/master,找到file_recv 去掉注释将false改为true.</div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>salt 'minion-id' cp.push /path/to/the/file</div></div><div>这样就从指定的minion上获取到了指定的文件</div><div><a href="https://docs.saltstack.com/en/latest/ref/configuration/master.html#std:conf_master-file_recv">https://docs.saltstack.com/en/latest/ref/configuration/master.html#std:conf_master-file_recv</a></div><div><br/></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div>[root@liujiangbu home]# salt -G  'os:centos'  grains.item  ipv4</div><div>visual:</div><div>    ----------</div><div>    ipv4:</div><div>        - 127.0.0.1</div><div>        - 192.168.220.130</div></div><div><br/></div><div>匹配参数：</div><div><a href="https://docs.saltstack.com/en/latest/topics/targeting/compound.html">https://docs.saltstack.com/en/latest/topics/targeting/compound.html</a></div><div><br/></div><div><br/></div><div><h3>get_file<a href="https://docs.saltstack.com/en/latest/ref/file_server/index.html#get-file" title="Permalink to this headline"></a></h3><p>The cp.get_file function can be used on the minion to download a file from the master, the syntax looks like this:</p></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># salt '*' cp.get_file salt://vimrc /etc/vimrc<br/></div></div><div><br/></div><div><br/></div><div><h3>get_dir<a href="https://docs.saltstack.com/en/latest/ref/file_server/index.html#get-dir" title="Permalink to this headline"></a></h3><p>The cp.get_dir function can be used on the minion to download an entire directory from the master. The syntax is very similar to get_file:</p></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># salt '*' cp.get_dir salt://etc/apache2 /etc<br/></div></div><div><br/></div><div><p>cp.get_dir supports template rendering and gzip compression arguments just like get_file:</p></div><div><br/></div><div style="-en-codeblock: true; box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;"><div># salt '*' cp.get_dir salt://etc/{{pillar.webserver}} /etc gzip=5 template=jinja<br/></div></div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-family: &quot;Microsoft YaHei&quot;; font-size: 16px;">实现pillar流程（</span><a href="http://www.cnblogs.com/shhnwangjian/p/5985868.html">http://www.cnblogs.com/shhnwangjian/p/5985868.html</a><span style="font-family: &quot;Microsoft YaHei&quot;; font-size: 16px;">）</span></div><div><br/></div><div><img src="salt命令_files/Image.png" type="image/png" style="height: auto;"/></div><div><br/></div><div align="left" style="min-height: 649pt;"><div><img src="salt命令_files/Image [1].png" type="image/png" alt="graphic" border="0" height="866" style="height: auto;" width="673"/></div></div><div><br/></div></span>
</div></body></html> 